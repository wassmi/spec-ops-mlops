name: Spec-Ops CI Pipeline

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

jobs:
  quality-gate:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install Linting & Security Tools
        run: |
          pip install black flake8 bandit safety

      - name: Security Scan (Python Code)
        run: bandit -r src/
        
      - name: Dependency Audit
        run: safety check

  build-and-verify:
    needs: quality-gate
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Build Image
        run: docker build -t spec-ops-api:${{ github.sha }} .

      - name: Container Security Scan (Trivy)
        uses: aquasecurity/trivy-action@master
        with:
          image-ref: 'spec-ops-api:${{ github.sha }}'
          format: 'table'
          exit-code: '1' # Fails the build if "High" vulnerabilities are found
          severity: 'CRITICAL,HIGH'

      - name: Performance Smoke Test
        run: |
          # Start container in background
          docker run -d -p 8000:8000 --name ci_test spec-ops-api:${{ github.sha }}
          sleep 15 # Wait for models to load
          
          # Ping health and check for > 2 TPS
          RESPONSE=$(curl -s http://localhost:8000/generate -H "Content-Type: application/json" -d '{"prompt": "Hi", "k_draft": 1}')
          TPS=$(echo $RESPONSE | jq -r '.tokens_per_second')
          
          if (( $(echo "$TPS < 2.0" | bc -l) )); then
            echo "❌ Performance Regression! TPS: $TPS is below threshold."
            exit 1
          fi
          echo "✅ Performance Verified: $TPS TPS"
          docker stop ci_test